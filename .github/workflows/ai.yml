name: Build & Release Multi-Arch Images (Enterprise Final)

permissions:
  contents: write
  packages: write
  id-token: write

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

############################################################
# Job 1: Build amd64 (always)
############################################################
jobs:
  build-amd64:
    name: Build amd64
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        dockerfile:
          - resources/Dockerfile.RHEL9.6
          - resources/Dockerfile.RKEL9.6
          - resources/Dockerfile.RKEL10.0
          - resources/Dockerfile.RHEL10.0

    steps:
      - uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker system prune -af || true

      - uses: docker/setup-buildx-action@v3

      - name: Login GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve tag
        id: tag
        run: |
          case "${{ matrix.dockerfile }}" in
            *RHEL9.6*) t=rhel9.6 ;;
            *RKEL9.6*) t=rkel9.6 ;;
            *RHEL10.0*) t=rhel10.0 ;;
            *RKEL10.0*) t=rkel10.0 ;;
          esac
          echo "tag=$t" >> $GITHUB_OUTPUT

      # ---------- builder: binaries ----------
      - name: Build binaries (amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          target: builder
          platforms: linux/amd64
          outputs: type=local,dest=./out-${{ steps.tag.outputs.tag }}-amd64
          cache-from: type=gha,scope=amd64
          cache-to: type=gha,scope=amd64,mode=min

      - name: Prepare binaries (amd64)
        run: |
          mkdir -p artifacts
          cp out-${{ steps.tag.outputs.tag }}-amd64/output/stalwart \
             artifacts/stalwart-${{ steps.tag.outputs.tag }}-amd64
          cp out-${{ steps.tag.outputs.tag }}-amd64/output/stalwart-cli \
             artifacts/stalwart-cli-${{ steps.tag.outputs.tag }}-amd64
          chmod +x artifacts/*
          sha256sum artifacts/* > artifacts/SHA256SUMS

      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ steps.tag.outputs.tag }}-amd64
          path: artifacts/

      # ---------- final image ----------
      - name: Build image (amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}-amd64
          cache-from: type=gha,scope=amd64
          cache-to: type=gha,scope=amd64,mode=min
          load: true

      - name: Save image (amd64)
        run: |
          docker save ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}-amd64 \
            | gzip > image-${{ steps.tag.outputs.tag }}-amd64.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: image-${{ steps.tag.outputs.tag }}-amd64
          path: image-${{ steps.tag.outputs.tag }}-amd64.tar.gz

############################################################
# Job 2: Build arm64 (ONLY on tag)
############################################################
  build-arm64:
    name: Build arm64 (release only)
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-24.04-arm64

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        dockerfile:
          - resources/Dockerfile.RHEL9.6
          - resources/Dockerfile.RKEL9.6
          - resources/Dockerfile.RKEL10.0
          - resources/Dockerfile.RHEL10.0

    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve tag
        id: tag
        run: |
          case "${{ matrix.dockerfile }}" in
            *RHEL9.6*) t=rhel9.6 ;;
            *RKEL9.6*) t=rkel9.6 ;;
            *RHEL10.0*) t=rhel10.0 ;;
            *RKEL10.0*) t=rkel10.0 ;;
          esac
          echo "tag=$t" >> $GITHUB_OUTPUT

      - name: Build binaries (arm64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          target: builder
          platforms: linux/arm64
          outputs: type=local,dest=./out-${{ steps.tag.outputs.tag }}-arm64
          cache-from: type=gha,scope=arm64
          cache-to: type=gha,scope=arm64,mode=min

      - name: Prepare binaries (arm64)
        run: |
          mkdir -p artifacts
          cp out-${{ steps.tag.outputs.tag }}-arm64/output/stalwart \
             artifacts/stalwart-${{ steps.tag.outputs.tag }}-arm64
          cp out-${{ steps.tag.outputs.tag }}-arm64/output/stalwart-cli \
             artifacts/stalwart-cli-${{ steps.tag.outputs.tag }}-arm64
          chmod +x artifacts/*
          sha256sum artifacts/* > artifacts/SHA256SUMS

      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ steps.tag.outputs.tag }}-arm64
          path: artifacts/

      - name: Build image (arm64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/arm64
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}-arm64
          cache-from: type=gha,scope=arm64
          cache-to: type=gha,scope=arm64,mode=min
          load: true

      - name: Save image (arm64)
        run: |
          docker save ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}-arm64 \
            | gzip > image-${{ steps.tag.outputs.tag }}-arm64.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: image-${{ steps.tag.outputs.tag }}-arm64
          path: image-${{ steps.tag.outputs.tag }}-arm64.tar.gz

############################################################
# Job 3: Release / Manifest / SBOM / Cosign
############################################################
  release:
    name: Release / Manifest / SBOM / Sign
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-amd64, build-arm64]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-arch manifests
        run: |
          for tag in rhel9.6 rkel9.6 rhel10.0 rkel10.0; do
            docker manifest create \
              ${{ env.IMAGE_NAME }}:$tag \
              --amend ${{ env.IMAGE_NAME }}:$tag-amd64 \
              --amend ${{ env.IMAGE_NAME }}:$tag-arm64
            docker manifest push ${{ env.IMAGE_NAME }}:$tag
          done

      - name: Install syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate SBOMs
        run: |
          mkdir sbom
          for tag in rhel9.6 rkel9.6 rhel10.0 rkel10.0; do
            syft ${{ env.IMAGE_NAME }}:$tag -o spdx-json > sbom/$tag.spdx.json
          done

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign images
        run: |
          for tag in rhel9.6 rkel9.6 rhel10.0 rkel10.0; do
            cosign sign --yes ${{ env.IMAGE_NAME }}:$tag
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: sbom/*.json
