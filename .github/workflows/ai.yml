name: Build & Push Multi-Arch Docker Images (Native ARM64)

permissions:
  contents: read
  packages: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}

############################################################
# Job 1: Build amd64 (native on ubuntu-latest)
############################################################
jobs:
  build-amd64:
    name: Build amd64 images
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        dockerfile:
          - resources/Dockerfile.RHEL9.6
          - resources/Dockerfile.RKEL9.6
          - resources/Dockerfile.RKEL10.0
          - resources/Dockerfile.RHEL10.0

    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker system prune -af

      - uses: docker/setup-buildx-action@v3

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve tag
        id: tag
        run: |
          case "${{ matrix.dockerfile }}" in
            *RHEL9.6*) t=rhel9.6 ;;
            *RKEL9.6*) t=rkel9.6 ;;
            *RHEL10.0*) t=rhel10.0 ;;
            *RKEL10.0*) t=rkel10.0 ;;
            *) t=custom ;;
          esac
          echo "tag=$t" >> $GITHUB_OUTPUT

      - name: Build & push amd64
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}-amd64
          cache-from: type=gha
          cache-to: type=gha,mode=min

############################################################
# Job 2: Build arm64 (NATIVE arm64 runner, NO QEMU)
############################################################
  build-arm64:
    name: Build arm64 images (native)
    needs: build-amd64

    # ✅ GitHub 官方 ARM64 Runner（Team / Enterprise）
    runs-on: ubuntu-24.04-arm64

    # 如果你用自托管 ARM64，改成下面这一行：
    # runs-on: [self-hosted, linux, arm64]

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        dockerfile:
          - resources/Dockerfile.RHEL9.6
          - resources/Dockerfile.RKEL9.6
          - resources/Dockerfile.RKEL10.0
          - resources/Dockerfile.RHEL10.0

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve tag
        id: tag
        run: |
          case "${{ matrix.dockerfile }}" in
            *RHEL9.6*) t=rhel9.6 ;;
            *RKEL9.6*) t=rkel9.6 ;;
            *RHEL10.0*) t=rhel10.0 ;;
            *RKEL10.0*) t=rkel10.0 ;;
            *) t=custom ;;
          esac
          echo "tag=$t" >> $GITHUB_OUTPUT

      - name: Build & push arm64 (native)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/arm64
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}-arm64
          cache-from: type=gha
          cache-to: type=gha,mode=min

############################################################
# Job 3: Create multi-arch manifest
############################################################
  manifest:
    name: Create multi-arch manifests
    needs: [build-amd64, build-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifests
        run: |
          set -e
          for tag in  rhel9.6 rkel9.6 rhel10.0 rkel10.0; do
            docker manifest create \
              ${{ env.IMAGE_NAME }}:$tag \
              --amend ${{ env.IMAGE_NAME }}:$tag-amd64 \
              --amend ${{ env.IMAGE_NAME }}:$tag-arm64

            docker manifest push ${{ env.IMAGE_NAME }}:$tag
          done
