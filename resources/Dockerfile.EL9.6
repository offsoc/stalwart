# syntax=docker/dockerfile:1

############################
# Builder (Rocky Linux 9)
############################
FROM rockylinux/rockylinux:9 AS builder
WORKDIR /build

# ---- Build dependencies ----
RUN set -eux; \
    # 更新元数据并允许失败（CI/CD 环境更稳定） \
    dnf --setopt=module_platform_id=platform:el9 -y update || true; \
    dnf install -y dnf-plugins-core epel-release; \
    # x86_64 启用 CRB
    if [ "$(uname -m)" = "x86_64" ]; then \
        dnf config-manager --set-enabled crb; \
    fi; \
    # 安装构建依赖，使用 --nobest 避免依赖冲突
    dnf install -y --allowerasing --nobest \
        gcc gcc-c++ make binutils \
        clang cmake pkg-config git curl \
        protobuf-devel protobuf-compiler \
        sqlite-devel librdkafka-devel \
        zlib-devel openssl-devel \
        ca-certificates; \
    dnf clean all && rm -rf /var/cache/dnf

# ---- Rust ----
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
RUN rustup default stable

# ---- FoundationDB client (multi-arch safe) ----
ARG TARGETARCH
RUN set -eux; \
    arch="${TARGETARCH:-$(uname -m)}"; \
    case "$arch" in \
        amd64|x86_64) fdb_arch="x86_64" ;; \
        arm64|aarch64) fdb_arch="arm64" ;; \
        *) echo "Unsupported arch: $arch" >&2; exit 1 ;; \
    esac; \
    cp "resources/libfdb_c.${fdb_arch}.so" /usr/lib64/libfdb_c.so; \
    chmod 0755 /usr/lib64/libfdb_c.so; \
    ldconfig

# ---- Collect runtime artifacts ----
RUN set -eux; \
    mkdir -p /build/runtime-artifacts; \
    for f in /usr/lib64/librdkafka*.so* /usr/lib64/libfdb_c.so /usr/lib64/libssl* /usr/lib64/libcrypto* /usr/lib64/libz*; do \
        [ -e "$f" ] && cp -v "$f" /build/runtime-artifacts/ || true; \
    done; \
    if [ -d /etc/pki/ca-trust ]; then \
        mkdir -p /build/runtime-artifacts/etc-pki-ca-trust && \
        cp -a /etc/pki/ca-trust/* /build/runtime-artifacts/etc-pki-ca-trust/ || true; \
    fi

# ---- Build application ----
COPY . .

RUN cargo build --release -p stalwart \
    --manifest-path crates/main/Cargo.toml \
    --no-default-features \
    --features "sqlite foundationdb postgres mysql rocks s3 redis azure nats zenoh kafka enterprise"

RUN cargo build --release -p stalwart-cli \
    --no-default-features \
    --features "sqlite foundationdb postgres mysql rocks s3 redis azure nats zenoh kafka enterprise"

RUN mkdir -p /output && \
    cp target/release/stalwart /output/ && \
    cp target/release/stalwart-cli /output/

############################
# Runtime - RHEL 9.6 / Rocky 9
############################
FROM registry.access.redhat.com/ubi9/ubi:9.6 AS runtime-el9
WORKDIR /opt/stalwart

LABEL org.opencontainers.image.licenses="AGPL-3.0-only"

# ---- Runtime libs (prefer distro, fallback to builder artifacts) ----
COPY --from=builder /build/runtime-artifacts /tmp/runtime-artifacts
ARG TARGETARCH

RUN set -eux; \
    if dnf -y install librdkafka openssl-libs zlib || dnf -y install librdkafka openssl zlib; then \
        echo "Runtime libs installed from distro"; \
    else \
        echo "Falling back to builder artifacts"; \
        cp -a /tmp/runtime-artifacts/* /usr/lib64/ || true; \
        if [ -d /tmp/runtime-artifacts/etc-pki-ca-trust ]; then \
            mkdir -p /etc/pki/ca-trust && \
            cp -a /tmp/runtime-artifacts/etc-pki-ca-trust/* /etc/pki/ca-trust/ || true; \
        fi; \
    fi; \
    dnf clean all && rm -rf /var/cache/dnf

# ---- Application binaries ----
COPY --from=builder /output/stalwart /usr/local/bin/stalwart
COPY --from=builder /output/stalwart-cli /usr/local/bin/stalwart-cli
COPY resources/docker/entrypoint.sh /usr/local/bin/entrypoint.sh

RUN chmod 0755 /usr/local/bin/stalwart /usr/local/bin/stalwart-cli /usr/local/bin/entrypoint.sh

# ---- Unprivileged user ----
RUN set -eux; \
    groupadd -r stalwart --gid 1000 || true; \
    useradd -r -g stalwart --uid 1000 --home-dir /opt/stalwart --shell /sbin/nologin stalwart || true; \
    chown -R stalwart:stalwart /opt/stalwart

# ---- Healthcheck ----
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD ["/usr/local/bin/stalwart","--version"] || exit 1

VOLUME ["/opt/stalwart"]
EXPOSE 443 25 110 587 465 143 993 995 4190 8080
ENTRYPOINT ["/bin/sh", "/usr/local/bin/entrypoint.sh"]
CMD ["/usr/local/bin/stalwart"]
